<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:DockTemplate.ViewModels.Tools"
             xmlns:converters="clr-namespace:DockTemplate.Converters"
             x:Class="DockTemplate.Views.Tools.OutputView"
             x:DataType="vm:OutputViewModel">

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>

    <!-- Toolbar -->
    <Border Grid.Row="0" 
            Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
            BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}"
            BorderThickness="0,0,0,1"
            >
      <Grid Margin="4">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <!-- Clear Button -->
        <Button Grid.Column="0"
                Command="{Binding ClearLogsCommand}"
                ToolTip.Tip="Clear Output"
                Background="Transparent"
                BorderThickness="0"
                
                Margin="0,0,4,0"
                Height="32"
                Width="32"
                VerticalAlignment="Center"
                VerticalContentAlignment="Center"
                FontFamily="avares://DockTemplate/Assets/FontAwesome-Solid.ttf#Font Awesome 6 Free"
                FontSize="11"
                Content="&#xf2ed;" />

        <!-- Log Level Filter -->
        <ComboBox Grid.Column="1"
                  ItemsSource="{Binding LogLevels}"
                  SelectedItem="{Binding SelectedLogLevel}"
                  Width="70"
                  Height="32"
                  Margin="0,0,4,0"
                  FontSize="10"
                  />

        <!-- Search Filter -->
        <TextBox Grid.Column="2"
                 Text="{Binding FilterText}"
                 Watermark="Filter logs..."
                 FontSize="10"
                 Height="32"
               
                 Margin="0,0,4,0"
                 VerticalContentAlignment="Center" />

        <!-- Auto-scroll Toggle -->
        <ToggleButton Grid.Column="3"
                      IsChecked="{Binding AutoScroll}"
                      ToolTip.Tip="Auto-scroll to bottom"
                      Background="Transparent"
                      BorderThickness="1"
                      Margin="0,0,4,0"
                      Height="32"
                      VerticalContentAlignment="Center"
                      FontFamily="avares://DockTemplate/Assets/FontAwesome-Solid.ttf#Font Awesome 6 Free"
                      FontSize="11"
                      Content="&#xf063;">
          <ToggleButton.Styles>
            <Style Selector="ToggleButton:checked">
              <Setter Property="Background" Value="{DynamicResource SystemAccentColor}" />
              <Setter Property="Foreground" Value="White" />
            </Style>
          </ToggleButton.Styles>
        </ToggleButton>

        <!-- Entry Count -->
        <TextBlock Grid.Column="4"
                   Text="{Binding LogEntries.Count, StringFormat=\{0\} entries}"
                   VerticalAlignment="Center"
                   FontSize="10"
                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
      </Grid>
    </Border>

    <!-- Log Display -->
    <Border Grid.Row="1" Background="{DynamicResource SystemControlBackgroundAltHighBrush}">
      <ListBox Name="LogListBox"
               ItemsSource="{Binding LogEntries}"
               Background="Transparent"
               ScrollViewer.HorizontalScrollBarVisibility="Auto"
               ScrollViewer.VerticalScrollBarVisibility="Auto">
        
        <ListBox.ItemTemplate>
          <DataTemplate>
            <Grid Margin="2,1">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
              </Grid.ColumnDefinitions>

              <!-- Timestamp -->
              <TextBlock Grid.Column="0"
                        Text="{Binding FormattedTimestamp}"
                        FontFamily="Consolas, Courier New, monospace"
                        FontSize="11"
                        Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                        Margin="0,0,8,0"
                        VerticalAlignment="Top" />

              <!-- Log Level Badge -->
              <Border Grid.Column="1"
                      Background="{Binding Level, Converter={x:Static converters:LogLevelToBrushConverter.Instance}}"
                      CornerRadius="2"

                      Margin="0,0,8,0"
                      VerticalAlignment="Top">
                <TextBlock Text="{Binding Level}"
                          FontSize="9"
                          FontWeight="Bold"
                          Foreground="White"
                          TextAlignment="Center"
                          MinWidth="35" />
              </Border>

              <!-- Message -->
              <StackPanel Grid.Column="2" Orientation="Vertical">
                <TextBlock Text="{Binding Message}"
                          FontFamily="Consolas, Courier New, monospace"
                          FontSize="11"
                          TextWrapping="Wrap"
                          Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}" />

                <!-- Exception Details (if any) -->
                <TextBlock Text="{Binding Exception}"
                          IsVisible="{Binding Exception, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                          FontFamily="Consolas, Courier New, monospace"
                          FontSize="10"
                          TextWrapping="Wrap"
                          Foreground="{DynamicResource SystemControlErrorTextForegroundBrush}"
                          />
              </StackPanel>
            </Grid>
          </DataTemplate>
        </ListBox.ItemTemplate>

        <ListBox.Styles>
          <Style Selector="ListBoxItem">
            <Setter Property="Padding" Value="4,0" />
            <Setter Property="Margin" Value="0,0,0,1" />
          </Style>
          
          <Style Selector="ListBoxItem:pointerover">
            <Setter Property="Background" Value="{DynamicResource SystemControlBackgroundListLowBrush}" />
          </Style>
        </ListBox.Styles>
      </ListBox>
    </Border>
  </Grid>
</UserControl>