<Project Sdk="Microsoft.NET.Sdk">

    <PropertyGroup>
        <ImplicitUsings>enable</ImplicitUsings>
        <TargetFramework>net9.0</TargetFramework>
        <Nullable>enable</Nullable>
        <AvaloniaUseCompiledBindingsByDefault>true</AvaloniaUseCompiledBindingsByDefault>
        
        <!-- Output component to shared Components-Output folder -->
        <OutputPath>..\..\Components-Output\$(Configuration)\</OutputPath>
    </PropertyGroup>

    <!-- Avalonia Resource Include for AXAML files -->
    <ItemGroup>
        <AvaloniaResource Include="Assets\**" />
    </ItemGroup>

    <!-- Component packages -->
    <ItemGroup>
        <PackageReference Include="Avalonia" Version="11.3.4" />
        <PackageReference Include="Avalonia.ReactiveUI" Version="11.3.4" />
        <PackageReference Include="ReactiveUI.Fody" Version="19.5.31" />
        <PackageReference Include="Dock.Model.Mvvm" Version="11.3.2.2" />
        <PackageReference Include="NLog" Version="6.0.3" />
    </ItemGroup>
    <ItemGroup>
      <ProjectReference Include="..\..\DockComponent.Base\DockComponent.Base.csproj" />
    </ItemGroup>
    
    <!-- Post-build target to create .dockplugin file -->
    <Target Name="CreateDockPlugin" AfterTargets="PostBuildEvent">
        <PropertyGroup>
            <PluginOutputDir>$(OutputPath)Plugin-Distribution</PluginOutputDir>
            <PluginName>Output-Component</PluginName>
            <PluginZipPath>$(PluginOutputDir)\$(PluginName).dockplugin</PluginZipPath>
        </PropertyGroup>
        
        <!-- Create distribution directory -->
        <MakeDir Directories="$(PluginOutputDir)" />
        
        <!-- Remove old plugin file if it exists -->
        <Delete Files="$(PluginZipPath)" Condition="Exists('$(PluginZipPath)')" />
        
        <Message Text="Creating .dockplugin file: $(PluginZipPath)" Importance="high" />
        <Message Text="Output path: $(OutputPath)" Importance="high" />
        <Message Text="Files to include:" Importance="high" />
        <Message Text="  - $(OutputPath)DockComponent.Output.dll" Importance="high" />
        <Message Text="  - $(OutputPath)DockComponent.Output.pdb" Importance="high" />
        
        <!-- Check if required files exist before creating ZIP -->
        <Error Condition="!Exists('$(OutputPath)DockComponent.Output.dll')" Text="Required file not found: $(OutputPath)DockComponent.Output.dll" />
        
        <!-- Create temporary directory for plugin contents -->
        <PropertyGroup>
            <TempPluginDir>$(OutputPath)temp-plugin</TempPluginDir>
        </PropertyGroup>
        <RemoveDir Directories="$(TempPluginDir)" />
        <MakeDir Directories="$(TempPluginDir)" />
        
        <!-- Copy files to temp directory -->
        <Copy SourceFiles="$(OutputPath)DockComponent.Output.dll" DestinationFolder="$(TempPluginDir)" />
        <Copy SourceFiles="$(OutputPath)DockComponent.Output.pdb" DestinationFolder="$(TempPluginDir)" Condition="Exists('$(OutputPath)DockComponent.Output.pdb')" />
        <Copy SourceFiles="$(OutputPath)DockComponent.Base.dll" DestinationFolder="$(TempPluginDir)" />
        
        <!-- Create ZIP using MSBuild ZipDirectory task (cross-platform) -->
        <ZipDirectory SourceDirectory="$(TempPluginDir)" DestinationFile="$(PluginZipPath)" Overwrite="true" />
        
        <!-- Clean up temp directory -->
        <RemoveDir Directories="$(TempPluginDir)" />
        
        <!-- Copy README.txt to distribution folder -->
        <Copy SourceFiles="README.txt" DestinationFolder="$(PluginOutputDir)" />
        
        <!-- Auto-export message contracts for easy consumption -->
        <PropertyGroup>
            <MessageContractsDir>$(PluginOutputDir)\MessageContracts</MessageContractsDir>
        </PropertyGroup>
        <MakeDir Directories="$(MessageContractsDir)" />
        
        <ItemGroup>
            <MessageFiles Include="Transport\**\*.cs" />
        </ItemGroup>
        
        <Copy SourceFiles="@(MessageFiles)" DestinationFolder="$(MessageContractsDir)" />
        
        <Message Text="✅ Created plugin: $(PluginZipPath)" Importance="high" />
        <Message Text="✅ Copied README.txt to distribution folder" Importance="high" />
        <Message Text="✅ Exported @(MessageFiles->Count()) message contract files for easy consumption" Importance="high" />
    </Target>

</Project>